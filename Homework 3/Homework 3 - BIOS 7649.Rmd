---
title: "Homework 3 - BIOS 7649"
author: "Dominic Adducci"
output: pdf_document
---

```{r, echo = F, warning = F, include = F}

library(tidyverse)
library(impute)
library(limma)
library(samr)
library(kableExtra)
library(qvalue)
library(gtools)
library(pbapply)

```

# Question 1: T-statistics

```{r, echo = F}

### START QUESTION 1 CODE ###

# Laptop Location:
# Desktop: "C:/Users/domin/Documents/Biostatistics Masters Program/Spring 2024/SMG-BIOS7659/Homework 3/hw3data/hw3arraydata.txt"
# Laptop: "C:/Biostatistics Masters Program/Spring 2024/SMG-BIOS7659/Homework 3/hw3data/hw3arraydata.txt"
array_data <- read.table("C:/Biostatistics Masters Program/Spring 2024/SMG-BIOS7659/Homework 3/hw3data/hw3arraydata.txt",row.names = 1, header = TRUE,
                         blank.lines.skip = FALSE)


# Data Location:
#Desktop: "C:/Users/domin/Documents/Biostatistics Masters Program/Spring 2024/SMG-BIOS7659/Homework 3/hw3data/hw3genenames.txt"
#Laptop: "C:/Biostatistics Masters Program/Spring 2024/SMG-BIOS7659/Homework 3/hw3data/hw3genenames.txt"
genenames_data <- read.table("C:/Biostatistics Masters Program/Spring 2024/SMG-BIOS7659/Homework 3/hw3data/hw3genenames.txt", header = FALSE, blank.lines.skip = FALSE)

colnames(genenames_data) <- "gene_name"

# Combining gene names with array data. 
array_genes <- cbind(genenames_data,array_data)

```

### Part A 
For each gene, calculate the fold change between the knock-out and wildtype groups. List the top 10 genes that show the largest fold change (positive or negative). 

There are 8 mice in the control group (C57B1/6 strain) and 8 mice in the experimental group (apo AI knockout). In order to calculate the fold change, either positive or negative between the two groups, the averages for each group needs to be calculated for each gene. 

```{r, echo = F}

## START QUESTION 1 PART A CODE ##

# Making a function which averages the subjects in each group and 
# finds the difference. 
fold_change <- function(index,data_frame){
  # index: Refers to the index which is currently being assessed
  # in the data frame. 
  # data_frame: The data frame with genes names and measurements. 
  
  # Extracting current row. 
  current_row <- data_frame[index,]
  
  control <- sum(current_row[,grepl("c",names(current_row))])/8
  experimental <- sum(current_row[,grepl("k",names(current_row))])/8
  gene_name <- current_row[,grepl("gene_name",names(current_row))]
  
  # Difference calculated by subtracting control group from experimental
  # group, e.g., positive values indicate experimental group is has 
  # higher expression, negative values indicate control group has 
  # higher expression. 
  difference <- experimental - control
  
  result <- c(gene_name,difference)
  
  return(result)
    
}

```

```{r, echo = F}

# Applying function to entire data frame. 
difference_result <- sapply(seq(1,nrow(array_genes),by = 1), 
                               function(x) fold_change(x,array_genes)) %>%
  t() %>% as.data.frame()

colnames(difference_result) <- c("gene_name","difference")

# Ordering data frame by absolute difference. 
diff_order <- difference_result %>% arrange(desc(abs(as.numeric(difference))))

diff_order_table <- kbl(head(diff_order,10),
                        col.names = c("Gene Name","Difference"),
                        caption = "10 Largest Absolute Fold Changes",
                        booktabs = TRUE, align = "lc") %>%
  kable_styling(latex_options = "HOLD_position")

diff_order_table

## FINISH QUESTION 1 PART A CODE ##

```

Table 1 illustrates the largest absolute difference in fold change. The difference was found by subtracting the averaged expression of the control group from the averaged expression of the experimental group. This means that positive values indicate increased expression in the experimental group, and negative valuees indicate increased expression in the control group. 

### Part B
Obtain the p-values from a two sided t-test for differential expression. How many genes are significant at the 0.01 level? List the top 10 genes that have the largest t-statistic and their corresponding p-value. 

```{r, echo = F}

## START QUESTION 1 PART B CODE ##

# Making a function that performs a t-test between the experimental and 
# control group for each gene. 
fold_ttest <- function(index,data_frame){
  # index: Refers to the index which is currently being assessed
  # in the data frame. 
  # data_frame: The data frame with genes names and measurements.
  
  # Extracting current row.
  current_row <- data_frame[index,]
  
  control <- current_row[,grepl("c",names(current_row))]
  experimental <- current_row[,grepl("k",names(current_row))]
  gene_name <- current_row[,grepl("gene_name",names(current_row))]
  
  # Running t-test on the experimental and control group.
  ttest_result <- t.test(control,experimental,alternative = "two.sided")
  
  # Extracting relevant information from t-test. 
  statistic_value <- ttest_result$statistic
  p_value <- ttest_result$p.value
  
  result <- c(gene_name,statistic_value,p_value)
  
  return(result)
  
}

```

```{r, echo = F}

# Applying function to entire data frame. 
ttest_result <- sapply(seq(1,nrow(array_genes),by = 1),
                       function(x) fold_ttest(x,array_genes)) %>%
  t() %>% as.data.frame()


colnames(ttest_result) <- c("gene_name","t_statistic","p_value")

# Ordering result by t-statistic. 
ttest_order <- ttest_result %>% arrange(desc(as.numeric(t_statistic))) %>%
  mutate(t_statistic = as.numeric(t_statistic),
         p_value = as.numeric(p_value),
         p_value = format.pval(p_value,digits = 3)) %>%
  mutate_if(is.numeric,round,digits = 3)

ttest_tbl <- kbl(head(ttest_order,10),
                 col.names = c("Gene Name","t-statistic","p-value"),
                 caption = "10 Largest t-statistics",
                 booktabs = TRUE, align = "lc") %>%
  kable_styling(latex_options = "HOLD_position")

ttest_tbl

## FINISH QUESTION 1 PART B CODE ##

```

### Part C: Alternative 't-statistics'

### Part C.i
Calculate the modified 't-statistic' and corresponding p-value using the **samr** package in R used in Homework 2. How many genes are significant at the 0.01 level? List the top 10 genes that have the largest 'penalized' t-statistics. 

```{r, echo = F, include = F}

## START QUESTION 1 PART C.i CODE ##

# Setting up list for the samr object. The data was already logged2 
# transformed, which is noted in the list. 
samr_list <- list(x = as.matrix(array_data),y = c(rep(1,8),rep(2,8)), 
                  geneid = genenames_data[,1], genenames = genenames_data[,1],
                  logged2 = TRUE)

# Setting up samr object. Assay type is array. testStatistic appears
# defaulted to "standard". 
samr.obj <- samr(samr_list,resp.type = "Two class unpaired", nperms = 500,
                 assay.type = "array")

delta.table <- samr.compute.delta.table(samr.obj)

# Computing significant genes table. all genes selected in order to then 
# select out the top 10. 
samr_test <- samr.compute.siggenes.table(samr.obj,del = 1,all.genes = TRUE, 
                                         data = samr_list,
                                         delta.table)

# Extracting information from the above variable to put in a table. 
genes_low_samr <- as.data.frame((samr_test$genes.lo)[,
                                                    c("Gene ID","Score(d)")])%>%
  mutate(`Score(d)` = as.numeric(`Score(d)`))


samr_test_tbl <- kbl(genes_low_samr[c(1:10),],
                     col.names = c("Gene Name","Score (Modified t-statistic)"),
                     booktabs = T, align = "lc", digits = 3) %>%
  kable_styling(latex_options = "HOLD_position")

# Determining how many genes are significant at the 0.01 level. 
genes_samr_sig <- genes_low_samr %>% filter(`Score(d)` <= 0.10)


```

```{r}

samr_test_tbl

## FINISH QUESTION 1 PART C.i CODE ##

```

Table 3 shows the results for 

### Part C.ii
Calculate the 'moderated' t-statistic and corresponding p-value using the **limma** package from BioConductor. How many genes are significant at the 0.01 level? List the top 10 genes that have the largest 'penalized' t-statistics. 

The 'moderated' t-statistic is 

```{r, echo = F}

## START QUESTION 1 PART C.ii CODE ##

# Code based on page 42 of limma user guide. 

# Setting up design matrix for control (c) and experimental (k) groups. 
design_mat <- cbind(Con = c(1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0),
                    Exp = c(0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1))

# Setting up contrast 
limma_fit <- lmFit(object = array_data, design = design_mat)
cont.mat <- makeContrasts(ExpvsCon = Exp - Con, levels = design_mat)
limma_fit2 <- eBayes(contrasts.fit(limma_fit,cont.mat))

# Extracting top 10 results. 
limma_results <- topTable(limma_fit2)

# Using row number to extract gene name for top 10 results. 
limma_genes <- genenames_data[rownames(limma_results),]

limma_table_df <- cbind(limma_genes,limma_results[,c(3,4,5)]) %>%
  mutate(P.Value = format.pval(P.Value,digits = 3),
         adj.P.Val = format.pval(adj.P.Val,digits = 3))

row.names(limma_table_df) <- NULL

limma_table <- kbl(limma_table_df,
                   caption = "10 Largest modified t-statistics - Limma",
                   col.names = c("Gene Name","Modified t-statistic",
                                 "p-value","Adj. p-value (BH)"),
                   booktabs = TRUE, align = "lccc",digits = 3) %>%
  kable_styling(latex_options = "HOLD_position")

limma_table

## FINISH QUESTION 1 PART C.ii CODE ##

### FINISH QUESTION 1 CODE ###

```

### Part D
Compare and contrast the results for the four methods for ranking genes. Explain the difference in how the different t-statistics are calculated. 



\newpage

# Question 2: P-values and Multiple Testing

### Part A
Calculate p-values for the t-statistics using permutations (B = 12870 possibilities). How many genes are significant at the 0.01 level? 

```{r, echo = F}

### START QUESTION 2 CODE ###

## START QUESTION 2 PART A CODE ##

permutation_test <- function(index,gene_data,ttest_statistic){
  # index: Refers to the index which is currently being assessed
  # in the data frame. 
  # gene_data: The data frame with genes names and measurements.
  # ttest_statistic: The data frame that holds the results of the t-test from
  # part 1B.
  
  # Extracting current row from data frame. 
  current_row <- gene_data[index,]
  
  # Extracting gene name.
  gene_name <- current_row[,"gene_name"]
  
  # Creating possible combinations
  current_comb <- combinations(16,8,unlist(current_row[,c(2:17)]))
  
  # Selecting out the initial t-value.
  t_value <- as.numeric(ttest_statistic[index,"t_statistic"])
  
  # Initializing a count to keep track of number of t_star values > t_value.
  count <- 0
  
  for(i in 1:nrow(current_comb)){
    control <- current_comb[i,]
    experimental <- setdiff(as.numeric(current_row[,c(2:17)]),control)
    t_test_perm <- t.test(control,experimental,alternative = "two.sided")
    t_star <- as.numeric(t_test_perm$statistic)
    if(abs(t_star) > abs(t_value)){
      count = count + 1
    }
    else count = count 
  }
  
  permutation_p <- count/nrow(current_comb)
  
  result <- c(gene_name,permutation_p)
  
  return(result)
}



```

```{r, echo = F, eval = F}

# Testing permutation function

perm_test <- pbsapply(seq(1,nrow(array_genes),by = 1),
                             function(x) permutation_test(x,array_genes,
                                                          ttest_result))

# Saving results of the permutation to an RDS file. 
#saveRDS(perm_test,"C:/Users/domin/Documents/Biostatistics Masters Program/Spring 2024/SMG-BIOS7659/Homework 3/hw3data/permutation_results.rds")

```

```{r, echo = F}

# Data Location:
# Desktop:
# Laptop: "C:/Biostatistics Masters Program/Spring 2024/SMG-BIOS7659/Homework 3/hw3data/permutation_results.rds"

# Loading in previously run permutation data. 
permutation_results <- readRDS("C:/Biostatistics Masters Program/Spring 2024/SMG-BIOS7659/Homework 3/hw3data/permutation_results.rds") %>% t() %>%
  as.data.frame %>% mutate(V2 = as.numeric(V2))

colnames(permutation_results) <- c("gene_name","p_value")

```

```{r, echo = F}

permutation_sig <- nrow(permutation_results %>% filter(p_value <= 0.01))

```

```{r}

test_matrix <- combinations(16,8,unlist(array_genes[1,c(2:17)]))

test_subset <- test_matrix[1,]

test_row <- as.numeric(array_genes[1,c(2:17)])

select_test <- setdiff(test_row,test_subset)

class(select_test)
class(test_subset)

```







